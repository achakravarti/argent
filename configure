#!/bin/sh


ok() {
	printf "[\033[0;32mOK\033[0m]   $1\n"
}


warn() {
	printf "[\033[0;33mWARN\033[0m] $1\n"
}


fail() {
	printf "[\033[0;31mFAIL\033[0m] $1\n"
	exit
}


exists_bin() {
	if [ $SHELL = "/bin/csh" ] ; then
		if which $1 1>/dev/null 2>/dev/null ; then
			return 0
		else
			return 1
		fi
	else
		if which $1 >&/dev/null ; then
			return 0
		else
			return 1
		fi
	fi
}


copyright() {
	echo "Argent Library Copyright (C) 2021 Abhishek Chakravarti"
	echo "This program comes with ABSOLUTELY NO WARRANTY; for details see LICENSE."
	echo "This is free software, and you are welcome to redistribute it"
	echo "under certain conditions; see LICENSE for details."
	echo ""
}


check_os() {
	OS=`uname`
	if [ $OS = "Linux" ] ; then
		ok "GNU/Linux detected..."
	elif [ $OS = "FreeBSD" ] ; then
		ok "FreeBSD detected..."
	else
		fail "Unsupported OS; use FreeBSD or a Linux distro."
	fi
}


check_dep() {
	exists_bin make
	[ $? -ne 0 ] || MAKE=make
	[ -z $MAKE ] && fail "make not found; install it first" \
	    || ok "make found"

	exists_bin gcc
	[ $? -ne 0 ] || GCC=gcc
	[ -z $GCC ] || ok "gcc found"
	
	exists_bin clang
	[ $? -ne 0 ] || CLANG=clang
	[ -z $CLANG ] || ok "clang found"

	if [ -z $GCC ] || [ -z $CLANG ] ; then
		fail "compiler not found; install either gcc or clang"
	fi
	
	exists_bin ccache
	[ $? -ne 0 ] || CCACHE=ccache
	[ -z $CCACHE ] && warn "ccache not found; compilation caching skipped" \
	    || ok "ccache found"
	
	exists_bin valgrind
	[ $? -ne 0 ] || VALGRIND=valgrind
	[ -z $VALGRIND ] && warn "valgrind not found; memory check skipped" \
	    || ok "valgrind found"
	
	exists_bin gcovr
	[ $? -ne 0 ] || GCOVR=gcovr
	[ -z $GCOVR ] && warn "gcovr not found; test coverage skipped" \
	    || ok "gcovr found"
	
	exists_bin psql
	[ $? -ne 0 ] && PSQL= || PSQL=psql
	
	exists_bin pg_config
	[ $? -ne 0 ] && PGCONFIG= || PGCONFIG=pg_config
	[ -z $PGCONFIG ] && fail "libpq not found; install it first" \
	    || ok "libpq found"
}


set_compiler() {
	if [ ! -z $GCC ] && [ ! -z $CLANG ] ; then
		echo
		echo "Both gcc and clang available; which do I use?"
		echo "  1) Default (gcc on Linux / clang on FreeBSD)"
		echo "  2) gcc"
		echo "  3) clang"
		printf "Select an option [default = 1]: "
		read CC 

		if [ -z $CC ] || [ $CC = "1" ] ; then
			[ $OS = "Linux" ] && CC=gcc || CC=clang
			ok "default compiler selected, setting CC to $CC"
		elif [ $CC = "2" ] ; then
			CC=gcc
			ok "gcc selected as compiler"
		elif [ $CC = "3" ] ; then
			CC=clang
			ok "clang selected as compiler"
		else
			fail "invalid option selected"
		fi
	elif [ -z $GCC ] ; then
		CC=clang
		ok "clang selected as compiler"
	else
		CC=gcc
		ok "gcc selected as compiler"
	fi
}


copyright
echo "Starting Argent build configuration..."
check_os
check_dep
set_compiler

